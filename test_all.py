import asyncio
import aiohttp
import json
import time


def get_questions():
    """Возвращает список из 100 различных вопросов."""
    questions = [
        "Какие специальности доступны в ИТМО для бакалавриата?",
        "Какова стоимость обучения в ИТМО для иностранных студентов?",
        "Какие гранты и стипендии предоставляет ИТМО?",
        "Как поступить на магистратуру в ИТМО?",
        "Какие требования для поступления в аспирантуру ИТМО?",
        "Каковы условия проживания в общежитиях ИТМО?",
        "Какие спортивные секции есть в ИТМО?",
        "Как подать заявку на участие в студенческих проектах ИТМО?",
        "Какие языковые требования для поступления в ИТМО?",
        "Есть ли в ИТМО курсы по искусственному интеллекту?",
        "Какой процент студентов ИТМО поступает в зарубежные университеты?",
        "Какие возможности для стажировок предоставляет ИТМО?",
        "Как работает система наставничества в ИТМО?",
        "Какие лаборатории есть в ИТМО для студентов?",
        "Как получить финансовую помощь для обучения в ИТМО?",
        "Какие программы обмена доступны для студентов ИТМО?",
        "Какова процедура подачи документов на грант в ИТМО?",
        "Есть ли в ИТМО онлайн-курсы для дистанционного обучения?",
        "Какие технологии используются в учебном процессе ИТМО?",
        "Как связаться с приемной комиссией ИТМО?",
        "Какие факультеты есть в ИТМО?",
        "Каковы карьерные перспективы выпускников ИТМО?",
        "Есть ли в ИТМО программы двойных дипломов?",
        "Каков средний балл поступающих в ИТМО?",
        "Какие дополнительные курсы можно пройти в ИТМО?",
        "Какой процент иностранных студентов обучается в ИТМО?",
        "Какие мероприятия проводятся для студентов ИТМО?",
        "Как получить стипендию за отличную успеваемость в ИТМО?",
        "Какие языки преподаются в ИТМО кроме русского?",
        "Каковы условия поступления на дневное отделение в ИТМО?",
        "Какие ресурсы доступны студентам ИТМО для исследований?",
        "Есть ли в ИТМО курсы по робототехнике?",
        "Каковы сроки подачи заявлений на поступление в ИТМО?",
        "Какие требования к портфолио для поступления в ИТМО?",
        "Какие возможности для трудоустройства предоставляются студентам ИТМО?",
        "Как зарегистрироваться на вступительные экзамены в ИТМО?",
        "Есть ли в ИТМО программы для студентов с ограниченными возможностями?",
        "Каковы правила проживания в общежитии ИТМО?",
        "Какие курсы повышения квалификации предлагает ИТМО?",
        "Какой процесс оценки заявок на гранты в ИТМО?",
        "Какие научные публикации выпускает ИТМО?",
        "Есть ли в ИТМО кружки по программированию?",
        "Какова система внутреннего распорядка в ИТМО?",
        "Какие библиотеки доступны студентам ИТМО?",
        "Как организован процесс обучения в магистратуре ИТМО?",
        "Есть ли в ИТМО курсы по кибербезопасности?",
        "Какой уровень поддержки студентов от преподавателей в ИТМО?",
        "Какие языковые курсы предоставляет ИТМО для иностранцев?",
        "Каков процесс адаптации новых студентов в ИТМО?",
        "Какие возможности для волонтёрской деятельности есть в ИТМО?",
        "Какова структура учебного плана в ИТМО?",
        "Какие лаборатории для исследований в области биоинформатики есть в ИТМО?",
        "Есть ли в ИТМО курсы по блокчейн-технологиям?",
        "Как проходит процесс регистрации на курсы в ИТМО?",
        "Какие системы поддержки студентов доступны в ИТМО?",
        "Как можно стать преподавателем в ИТМО?",
        "Какие международные партнеры сотрудничества у ИТМО?",
        "Каковы условия проживания на кампусе ИТМО?",
        "Есть ли в ИТМО курсы по машинному обучению?",
        "Каковы требования к языковым сертификатам для поступления в ИТМО?",
        "Какие студенческие организации существуют в ИТМО?",
        "Какова продолжительность обучения на бакалавриате в ИТМО?",
        "Есть ли в ИТМО программы для предпринимателей?",
        "Какие мероприятия проводятся на факультете компьютерных наук в ИТМО?",
        "Какой уровень технической оснащённости имеет ИТМО?",
        "Какие факультеты наиболее популярны в ИТМО?",
        "Есть ли в ИТМО программы поддержки стартапов?",
        "Каковы возможности для участия в международных конференциях для студентов ИТМО?",
        "Какие ресурсы предоставляет ИТМО для дистанционного обучения?",
        "Какова средняя продолжительность магистратуры в ИТМО?",
        "Есть ли в ИТМО курсы по разработке игр?",
        "Каковы требования к дипломным работам в ИТМО?",
        "Какие возможности для междисциплинарных исследований предлагает ИТМО?",
        "Какова система оценки успеваемости в ИТМО?",
        "Есть ли в ИТМО программы для работы над открытым исходным кодом?",
        "Как проходит процесс отбора на магистратуру в ИТМО?",
        "Какие программы дополнительного образования предлагает ИТМО?",
        "Есть ли в ИТМО курсы по интернет-маркетингу?",
        "Какова поддержка студентов ИТМО в карьерном росте?",
        "Какие условия для проживания в квартире ИТМО?",
        "Есть ли в ИТМО курсы по облачным технологиям?",
        "Какова история основания ИТМО?",
        "Какие инновационные проекты реализуются в ИТМО?",
        "Есть ли в ИТМО программы двойного бакалавриата?",
        "Каковы возможности для участия в международных стажировках для студентов ИТМО?",
        "Какие языковые программы предлагает ИТМО для изучения иностранных языков?",
        "Какова система грантов для научных исследований в ИТМО?",
        "Есть ли в ИТМО курсы по разработке мобильных приложений?",
        "Каковы условия вступления в студенческие общества ИТМО?",
        "Какие возможности для публикации научных работ предоставляет ИТМО?",
        "Есть ли в ИТМО курсы по дизайну пользовательских интерфейсов?",
        "Как проходит процесс защиты дипломной работы в ИТМО?",
        "Какие мероприятия для релаксации организуются для студентов в ИТМО?",
        "Есть ли в ИТМО курсы по анализу больших данных?",
        "Каковы возможности для получения дополнительной практики во время обучения в ИТМО?",
        "Какие социальные программы поддерживают студентов в ИТМО?",
        "Есть ли в ИТМО курсы по разработке веб-приложений?",
        "Какова система наставничества для новых студентов в ИТМО?",
        "Какие возможности для участия в международных проектах предоставляет ИТМО?",
        "Есть ли в ИТМО курсы по компьютерному зрению?"
    ]
    return questions


async def send_request(session, url, data, idx, semaphore):
    """Асинхронная функция для отправки одного запроса."""
    async with semaphore:
        start_time = time.time()
        try:
            async with session.post(url, json=data) as response:
                elapsed_time = time.time() - start_time
                if response.status == 200:
                    result = await response.json()
                    print(f"Вопрос {idx}: Успешно обработан за {elapsed_time:.2f} секунд.")
                    return result, elapsed_time
                else:
                    text = await response.text()
                    print(f"Вопрос {idx}: Ошибка {response.status} - {text}")
                    return None, elapsed_time
        except Exception as e:
            elapsed_time = time.time() - start_time
            print(f"Вопрос {idx}: Исключение - {e} (затрачено {elapsed_time:.2f} секунд)")
            return None, elapsed_time


async def test_api_with_questions(url, questions, max_concurrent=20):
    """Асинхронное тестирование API с набором вопросов и подсчет общего времени инференса."""
    total_time = 0
    responses = []
    semaphore = asyncio.Semaphore(max_concurrent)

    start_total = time.time()

    async with aiohttp.ClientSession() as session:
        tasks = []
        for idx, question in enumerate(questions, 1):
            data = {
                "id": idx,
                "query": question
            }
            task = asyncio.create_task(send_request(session, url, data, idx, semaphore))
            tasks.append(task)

        # Собираем результаты по мере завершения задач
        for task in asyncio.as_completed(tasks):
            result, elapsed_time = await task
            total_time += elapsed_time
            if result:
                responses.append(result)

    total_elapsed = time.time() - start_total

    print("\n--- Итоги Тестирования ---")
    print(f"Общее количество вопросов: {len(questions)}")
    print(f"Общее время инференса: {total_elapsed:.2f} секунд.")
    print(f"Среднее время на вопрос: {total_elapsed / len(questions):.2f} секунд.")

    # Сохранение ответов в файл
    with open("api_responses_async.json", "w", encoding="utf-8") as f:
        json.dump(responses, f, ensure_ascii=False, indent=4)
    print("Ответы сохранены в файл 'api_responses_async.json'.")


if __name__ == "__main__":
    url = "http://127.0.0.1:8081/api/request"
    questions = get_questions()
    asyncio.run(test_api_with_questions(url, questions))